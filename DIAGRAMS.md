# 📊 Диаграмма работы Telegram Integration

## 🔄 Схема работы Client-side

```
┌─────────────────────────────────────────────────────────────┐
│                    БРАУЗЕР ПОЛЬЗОВАТЕЛЯ                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      index.html                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │         React Application                         │     │
│  │  ┌─────────────────────────────────────┐         │     │
│  │  │    ContactFormBlock (B13)           │         │     │
│  │  │  ┌───────────────────────────┐     │         │     │
│  │  │  │  <form>                   │     │         │     │
│  │  │  │    <input name="name">    │     │         │     │
│  │  │  │    <input name="contact"> │     │         │     │
│  │  │  │    <textarea>             │     │         │     │
│  │  │  │    <button type="submit"> │     │         │     │
│  │  │  └───────────────────────────┘     │         │     │
│  │  └─────────────────────────────────────┘         │     │
│  └───────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              telegram-integration.js                        │
│                                                             │
│  1️⃣  MutationObserver                                       │
│      └─→ Обнаружение форм                                  │
│                                                             │
│  2️⃣  addEventListener('submit')                             │
│      └─→ Перехват отправки                                 │
│                                                             │
│  3️⃣  Сбор данных                                            │
│      └─→ { name, contact, message }                        │
│                                                             │
│  4️⃣  Валидация                                              │
│      ├─→ Проверка длины                                    │
│      ├─→ Проверка на XSS                                   │
│      └─→ Rate limiting                                     │
│                                                             │
│  5️⃣  Форматирование                                         │
│      └─→ HTML с эмодзи                                     │
│                                                             │
│  6️⃣  fetch() → Telegram API                                │
│                                                             │
│  7️⃣  Обработка ответа                                       │
│      ├─→ Успех: уведомление + очистка                     │
│      └─→ Ошибка: уведомление с описанием                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Telegram Bot API                               │
│         https://api.telegram.org/bot<TOKEN>                 │
│                                                             │
│  POST /sendMessage                                          │
│  {                                                          │
│    "chat_id": "771386337",                                  │
│    "text": "🚀 Новая заявка...",                           │
│    "parse_mode": "HTML"                                     │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM                                 │
│                                                             │
│  Chat ID: 771386337                                         │
│                                                             │
│  🚀 Новая заявка с сайта                                    │
│                                                             │
│  👤 Имя: Иван Иванов                                        │
│  📞 Контакт: ivan@example.com                               │
│  📝 Текст: Интересует сотрудничество                        │
│                                                             │
│  ⏰ Время: 04.01.2026, 18:58:21                             │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Схема работы Server-side (опционально)

```
┌─────────────────────────────────────────────────────────────┐
│                    БРАУЗЕР ПОЛЬЗОВАТЕЛЯ                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              telegram-integration.js                        │
│              (модифицированный)                             │
│                                                             │
│  fetch('http://localhost:3000/api/contact', {              │
│    method: 'POST',                                          │
│    body: JSON.stringify(formData)                          │
│  })                                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              ВАШ СЕРВЕР (Node.js)                           │
│              server-example.js                              │
│                                                             │
│  1️⃣  Express Middleware                                     │
│      ├─→ CORS                                              │
│      ├─→ Rate Limiter                                      │
│      └─→ JSON Parser                                       │
│                                                             │
│  2️⃣  Валидация данных                                       │
│      ├─→ Проверка полей                                    │
│      ├─→ Проверка на XSS                                   │
│      └─→ Экранирование HTML                                │
│                                                             │
│  3️⃣  Логирование                                            │
│      └─→ IP, время, данные                                 │
│                                                             │
│  4️⃣  Отправка в Telegram                                    │
│      └─→ Bot Token из .env                                 │
│                                                             │
│  5️⃣  Ответ клиенту                                          │
│      └─→ { success: true/false, message }                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Telegram Bot API                               │
│         https://api.telegram.org/bot<TOKEN>                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    TELEGRAM                                 │
│                                                             │
│  🚀 Новая заявка с сайта                                    │
│  👤 Имя: ...                                                │
│  📞 Контакт: ...                                            │
│  📝 Текст: ...                                              │
│  ⏰ Время: ...                                              │
│  🌐 IP: 192.168.1.1                                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔐 Безопасность: Client-side vs Server-side

```
┌──────────────────────────────────────────────────────────────┐
│                    CLIENT-SIDE                               │
├──────────────────────────────────────────────────────────────┤
│  ✅ Простота реализации                                       │
│  ✅ Не требует сервера                                        │
│  ✅ Работает сразу                                            │
│                                                              │
│  ⚠️  Bot Token виден в коде                                  │
│  ⚠️  Возможность злоупотребления                             │
│  ⚠️  Ограниченная защита                                     │
│                                                              │
│  🔒 Защита:                                                  │
│     • Rate limiting (3 запроса/мин)                         │
│     • Валидация данных                                      │
│     • Экранирование HTML                                    │
│     • Проверка на XSS                                       │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                    SERVER-SIDE                               │
├──────────────────────────────────────────────────────────────┤
│  ✅ Bot Token скрыт                                           │
│  ✅ Полный контроль                                           │
│  ✅ Расширенная валидация                                     │
│  ✅ IP логирование                                            │
│  ✅ Production ready                                          │
│                                                              │
│  ⚠️  Требует сервер                                          │
│  ⚠️  Сложнее настройка                                       │
│  ⚠️  Дополнительные затраты                                  │
│                                                              │
│  🔒 Защита:                                                  │
│     • Express Rate Limiter                                  │
│     • Валидация на сервере                                  │
│     • CORS настройки                                        │
│     • Helmet.js (опционально)                               │
│     • CAPTCHA (опционально)                                 │
└──────────────────────────────────────────────────────────────┘
```

## 📊 Поток данных

```
Пользователь
    │
    │ 1. Заполняет форму
    ▼
Форма (HTML)
    │
    │ 2. Submit event
    ▼
Event Listener
    │
    │ 3. preventDefault()
    ▼
Сбор данных
    │
    │ 4. querySelector()
    ▼
Валидация
    │
    ├─→ ❌ Ошибка → Уведомление
    │
    └─→ ✅ OK
         │
         ▼
    Rate Limit Check
         │
         ├─→ ❌ Превышен → Уведомление
         │
         └─→ ✅ OK
              │
              ▼
         Форматирование
              │
              │ HTML + эмодзи
              ▼
         Fetch API
              │
              │ POST запрос
              ▼
         Telegram API
              │
              ├─→ ❌ Ошибка → Уведомление
              │
              └─→ ✅ Успех
                   │
                   ├─→ Уведомление
                   ├─→ Очистка формы
                   └─→ Логирование
```

## 🎨 UX Flow

```
┌─────────────────────────────────────────────────────────────┐
│  Пользователь открывает страницу                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Скрипт загружается и инициализируется                      │
│  Console: "🚀 Telegram Integration: Initializing..."        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Форма обнаружена и интегрирована                           │
│  Console: "✅ Telegram Integration: Form integrated"        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Пользователь заполняет поля                                │
│  • Имя                                                      │
│  • Контакт                                                  │
│  • Сообщение                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Нажимает "Отправить"                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Кнопка блокируется                                         │
│  Текст: "Отправка..."                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Валидация и отправка                                       │
│  (1-2 секунды)                                              │
└─────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌───────────────────┐       ┌───────────────────┐
    │  ✅ УСПЕХ          │       │  ❌ ОШИБКА         │
    ├───────────────────┤       ├───────────────────┤
    │ • Зеленое         │       │ • Красное         │
    │   уведомление     │       │   уведомление     │
    │ • Форма очищена   │       │ • Форма НЕ        │
    │ • Кнопка          │       │   очищена         │
    │   разблокирована  │       │ • Кнопка          │
    │ • Логирование     │       │   разблокирована  │
    └───────────────────┘       └───────────────────┘
                │                           │
                └─────────────┬─────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Уведомление исчезает через 4 секунды                       │
└─────────────────────────────────────────────────────────────┘
```

## 🔍 Детали валидации

```
validateFormData(data)
    │
    ├─→ Проверка имени
    │   └─→ Минимум 2 символа
    │
    ├─→ Проверка контакта
    │   └─→ Минимум 5 символов
    │
    └─→ Проверка на XSS
        ├─→ /<script/i
        ├─→ /javascript:/i
        └─→ /on\w+\s*=/i
```

## 📈 Rate Limiting

```
RATE_LIMIT = {
    maxRequests: 3,
    timeWindow: 60000,  // 1 минута
    requests: []
}

checkRateLimit()
    │
    ├─→ Очистка старых запросов
    │   └─→ filter(time => now - time < 60000)
    │
    ├─→ Проверка лимита
    │   └─→ requests.length >= 3 ?
    │
    └─→ Добавление нового запроса
        └─→ requests.push(now)
```

---

*Диаграммы созданы для проекта RESUME-000*
*Дата: 04.01.2026*
